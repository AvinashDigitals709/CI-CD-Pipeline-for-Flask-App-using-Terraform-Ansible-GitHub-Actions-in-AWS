name: CI-CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      BUCKET_NAME: terraform-state-avinash-backend   # <-- change bucket name if needed

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------
    # Install Terraform & Ansible
    # ---------------------------
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Install Ansible
      run: sudo apt-get update && sudo apt-get install -y ansible

    # ---------------------------
    # Setup AWS credentials
    # ---------------------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

        # ---------------------------
    # AUTO-CREATE S3 BACKEND BUCKET (us-east-1 SAFE)
    # ---------------------------
    - name: Create S3 Bucket for Terraform Backend
      run: |
        echo "Checking S3 bucket: $BUCKET_NAME in region: $AWS_REGION"

        if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
          echo "S3 bucket already exists."
        else
          if [ "$AWS_REGION" = "us-east-1" ]; then
            echo "Creating bucket in us-east-1 WITHOUT LocationConstraint"
            aws s3api create-bucket --bucket "$BUCKET_NAME"
          else
            echo "Creating bucket in $AWS_REGION WITH LocationConstraint"
            aws s3api create-bucket \
              --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
          fi
        fi

    # ---------------------------
    # Terraform init/plan/apply
    # ---------------------------
    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Plan
      working-directory: terraform
      run: terraform plan

    - name: Terraform Apply
      working-directory: terraform
      run: terraform apply -auto-approve

    # ---------------------------
    # Get EC2 IP (Clean & Safe)
    # ---------------------------
    - name: Export EC2 Public IP
      working-directory: terraform
      run: |
        # Extract ONLY IPv4 using grep
        IP=$(terraform output ec2_public_ip | grep -oE "([0-9]{1,3}\.){3}[0-9]{1,3}")

        if [ -z "$IP" ]; then
          echo "ERROR: Could not extract EC2 IP!"
          exit 1
        fi

        echo "EC2_IP=$IP" >> $GITHUB_ENV
        echo "Clean EC2 Public IP: $IP"



    # ---------------------------
    # Create SSH Key
    # ---------------------------
    - name: Write SSH key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key.pem
        chmod 600 ssh_key.pem

    - name: Create Dynamic Inventory
      run: |
        echo "[flask]" > inventory.ini
        echo "${{ env.EC2_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=ssh_key.pem" >> inventory.ini

    # ---------------------------
    # Run Ansible
    # --------------------------- 
    - name: Run Ansible Playbook
      run: ansible-playbook -i inventory.ini ansible/deploy.yml
