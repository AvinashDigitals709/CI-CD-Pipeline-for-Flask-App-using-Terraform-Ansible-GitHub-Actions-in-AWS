name: CI-CD

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      BUCKET_NAME: terraform-state-avinash-backend   # <-- change bucket name if needed

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # ---------------------------
    # Install Terraform & Ansible
    # ---------------------------
    - name: Install Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Install Ansible
      run: sudo apt-get update && sudo apt-get install -y ansible

    # ---------------------------
    # Setup AWS credentials
    # ---------------------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

        # ---------------------------
    # AUTO-CREATE S3 BACKEND BUCKET (us-east-1 SAFE)
    # ---------------------------
    - name: Create S3 Bucket for Terraform Backend
      run: |
        echo "Checking S3 bucket: $BUCKET_NAME in region: $AWS_REGION"

        if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
          echo "S3 bucket already exists."
        else
          if [ "$AWS_REGION" = "us-east-1" ]; then
            echo "Creating bucket in us-east-1 WITHOUT LocationConstraint"
            aws s3api create-bucket --bucket "$BUCKET_NAME"
          else
            echo "Creating bucket in $AWS_REGION WITH LocationConstraint"
            aws s3api create-bucket \
              --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
          fi
        fi

    # ---------------------------
    # Terraform init/plan/apply
    # ---------------------------
    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Plan
      working-directory: terraform
      run: terraform plan

    - name: Terraform Apply
      working-directory: terraform
      run: terraform apply -auto-approve


    - name: Wait for SSH to become available
      run: |
        for i in {1..15}; do
          nc -zv $EC2_IP 22 && echo "SSH is ready!" && exit 0
          echo "Waiting for SSH..."
          sleep 10
        done
        echo "EC2 SSH did not become ready in time" >&2
        exit 1





    # ---------------------------
    # GET EC2 PUBLIC IP (IMPROVED)
    # ---------------------------
    - name: Get EC2 Public IP
      id: get-ec2-ip
      working-directory: terraform
      run: |
        echo "----------------------------------------"
        echo " Fetching EC2 Public IP from Terraform..."
        echo "----------------------------------------"

        # Extract IP safely from terraform output
        IP=$(terraform output -raw ec2_public_ip 2>&1 | grep -oE '([0-9]{1,3}\.){3}[0-9]{1,3}' | head -1)

        if [ -z "$IP" ]; then
          echo "âŒ ERROR: Unable to extract EC2 Public IP"
          exit 1
        fi

        echo " EC2 Public IP successfully extracted: $IP"

        # Export to environment variables
        echo "EC2_IP=$IP" >> $GITHUB_ENV
        echo "ip=$IP" >> $GITHUB_OUTPUT

        echo "----------------------------------------"
        echo " EC2_IP exported and ready for next steps"
        echo "----------------------------------------"




    # ---------------------------
    # Create SSH Key
    # ---------------------------
    - name: Write SSH key
      run: |
        echo "${{ secrets.SSH_PRIVATE_KEY }}" > ssh_key.pem
        chmod 600 ssh_key.pem

    - name: Create Dynamic Inventory
      run: |
        echo "[flask]" > inventory.ini
        echo "${{ env.EC2_IP }} ansible_user=ubuntu ansible_ssh_private_key_file=ssh_key.pem" >> inventory.ini


    - name: Disable SSH host key checking
      run: echo "ANSIBLE_HOST_KEY_CHECKING=False" >> $GITHUB_ENV

    # ---------------------------
    # Run Ansible
    # --------------------------- 
    - name: Run Ansible Playbook
      run: ansible-playbook -i inventory.ini ansible/deploy.yml
